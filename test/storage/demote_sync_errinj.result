test_run = require('test_run').new()
---
...
REPLICASET_1 = { 'storage_1_a', 'storage_1_b' }
---
...
REPLICASET_2 = { 'storage_2_a', 'storage_2_b' }
---
...
test_run:create_cluster(REPLICASET_1, 'storage')
---
...
test_run:create_cluster(REPLICASET_2, 'storage')
---
...
util = require('util')
---
...
util.wait_master(test_run, REPLICASET_1, 'storage_1_a')
---
...
util.wait_master(test_run, REPLICASET_2, 'storage_2_a')
---
...
test_run:switch('storage_1_a')
---
- true
...
fiber = require('fiber')
---
...
s = box.schema.create_space('test')
---
...
pk = s:create_index('pk')
---
...
vshard.storage.internal.errinj.ERRINJ_CFG_DELAY = true
---
...
cfg.sharding[util.replicasets[1]].replicas[util.name_to_uuid.storage_1_b].master = true
---
...
cfg.sharding[util.replicasets[1]].replicas[util.name_to_uuid.storage_1_a].master = false
---
...
f = fiber.create(function() vshard.storage.cfg(cfg, util.name_to_uuid.storage_1_a) end)
---
...
f:status()
---
- suspended
...
-- Can not write - read only mode is already on.
s:replace{1}
---
- error: Can't modify data because this instance is in read-only mode.
...
test_run:switch('storage_1_b')
---
- true
...
cfg.sharding[util.replicasets[1]].replicas[util.name_to_uuid.storage_1_b].master = true
---
...
cfg.sharding[util.replicasets[1]].replicas[util.name_to_uuid.storage_1_a].master = false
---
...
vshard.storage.cfg(cfg, util.name_to_uuid.storage_1_b)
---
...
box.space.test:select{}
---
- []
...
test_run:switch('storage_1_a')
---
- true
...
vshard.storage.internal.errinj.ERRINJ_CFG_DELAY = false
---
...
while f:status() ~= 'dead' do fiber.sleep(0.1) end
---
...
s:select{}
---
- []
...
test_run:switch('storage_1_b')
---
- true
...
box.space.test:select{}
---
- []
...
box.space.test:drop()
---
...
test_run:cmd("switch default")
---
- true
...
test_run:drop_cluster(REPLICASET_2)
---
...
test_run:drop_cluster(REPLICASET_1)
---
...
